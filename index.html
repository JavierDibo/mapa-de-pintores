<!DOCTYPE html>
<html lang="es-ES" xmlns="http://www.w3.org/1999/xhtml">

<head profile="http://gmpg.org/xfn/11">
    <!-- SEE https://asmaloney.com/2014/01/code/creating-an-interactive-map-with-leaflet-and-openstreetmap/ -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style>
        html {
            height: 100%;
        }

        body {
            height: 100%; /* Changed from min-height: 100vh for consistency */
            margin: 0;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #2c2c2c;
            color: #e0e0e0;
            font-size: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #page-wrapper {
            width: 100%;
            height: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #2c2c2c;
            padding: 5px;
            box-sizing: border-box;
            border-radius: 0px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
            gap: 20px;
            margin: 0 0;
        }

        #map {
            height: 100%;
            border-radius: 8px;
        }

        #info-slider-area {
            /* height: 27%; /* Removed: Let height be determined by content */
            width: 95%; /* Changed from 100% to 95% to match centering intent */
            margin: 0 auto; /* Added: For centering the block */
            display: flex;
            flex-direction: column;
            align-items: center; /* Added: To center content like the slider horizontally */
            justify-content: center; /* Added: To center content vertically if area has free space */
            /* overflow-y: auto; /* Removed: Likely not needed with auto height */
            padding: 15px;
            box-sizing: border-box; /* Added: For consistent box model behavior */
        }

        #map-container {
            flex: 1;
            height: 100%;
            border: 1px solid #444;
            border-radius: 8px;
            box-sizing: border-box;
        }

        #details-panel {
            flex: 1;
            height: 100%;
            border: 1px solid #444;
            border-radius: 8px;
            overflow-y: auto;
            background-color: #2c2c2c;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 0.6em;
            box-sizing: border-box;
            padding: 15px;  /* Added padding for inner spacing */
        }

        h1 {
            text-align: center;
            color: #bb86fc;
            padding: 10px 0;
            margin: 0 0 10px 0;
            font-size: 55px;
            font-weight: 300;
        }

        #intro-paragraph {
            text-align: center;
            margin: 0 0 15px 0;
            color: #b0b0b0;
            font-size: 25px;
        }

        p {
            line-height: 1.6;
        }

        #slider-container {
            width: 90%;
            margin: auto auto;
            padding: 10px 55px;
            background-color: #333;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        #slider-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            position: relative;
            height: 40px;
            /* Space for top labels */
        }

        #slider-bottom-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            position: relative;
            height: 40px;
            /* Space for bottom labels */
        }

        .slider-label {
            position: absolute;
            font-size: 17.5px;
            color: #c0c0c0;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            text-align: center;
            width: 100px;
            /* Fixed width for label */
            transform: translateX(-50%);
            /* Center the label on its position */
        }

        .slider-label:hover {
            background-color: #3f3f3f;
        }

        .slider-label>span:first-child {
            font-weight: 500;
            display: block;
        }

        .slider-label>span:last-child {
            font-size: 0.9em;
            color: #999999;
            display: block;
        }

        .slider-label.active-label>span:first-child {
            /* Style for active label name */
            color: #bb86fc;
            /* Highlight color */
        }

        .slider-label.active-label {
            /* Style for active label container */
            font-weight: 600;
            /* Bolder */
            background-color: #4a4a4a;
            /* Slightly different background */
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #4a4a4a;
            border-radius: 5px;
            outline: none;
            opacity: 0.9;
            -webkit-transition: .2s;
            transition: opacity .2s;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #bb86fc;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #2c2c2c;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #bb86fc;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #2c2c2c;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        #details-panel h2 {
            color: #bb86fc;
            font-size: 1.6em;
            margin-bottom: 10px;
        }

        #details-panel p {
            font-size: 0.95em;
            margin-bottom: 8px;
            color: #d0d0d0;
        }

        #details-panel strong {
            color: #e0e0e0;
        }

        #details-panel em {
            color: #a0a0a0;
        }

        #details-panel img {
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #555;
        }

        #wikipedia-summary-container h4 {
            margin-top: 15px;
            margin-bottom: 5px;
            color: #bb86fc;
            font-size: 1.2em;
        }

        #wikipedia-summary-container p {
            color: #d0d0d0;
            font-size: 0.9em;
        }

        #wikipedia-summary-container p a {
            color: #8ab4f8;
            text-decoration: none;
        }

        #wikipedia-summary-container p a:hover {
            text-decoration: underline;
        }

        #page-footer {
            width: 100%;
            padding: 0 0;
            text-align: center;
            background-color: #2c2c2c;
            color: #b0b0b0;
            font-size: 0.6em;
            border-radius: 0px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
            margin-top: 20px;  /* Added to create separation from content above */
        }

        #page-footer p {
            margin: 0;
            line-height: 1.4;
        }

        #main-content-row {
            display: flex;
            flex-direction: row;
            flex-grow: 1;
            width: 100%;
            gap: 20px;
            overflow: hidden;
        }

        .details-placeholder {
            color: #888;
            /* Lighter gray */
            font-size: 1.1em;
            /* Reverted from 50em */
            font-style: italic;
            text-align: center;
            padding-top: 40px;
            /* Space from the top */
            line-height: 1.5;
            /* Better readability */
        }
    </style>

    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'>
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />

    <!-- Leaflet.markercluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

</head>

<body>
    <div id="page-wrapper">
        <div id="info-slider-area">
            <h1>Pintores del mundo y sus raíces</h1>
            <!--           <p id="intro-paragraph">Selecciona un movimiento artístico para ver pintores asociados y sus lugares de nacimiento.</p>
 -->
            <div id="slider-container">
                <div id="slider-labels" style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <!-- Labels will be populated by JavaScript -->
                </div>
                <input type="range" id="artisticMovementSlider" name="artisticMovementSlider" min="0" max="12" value="0"
                    style="width: 100%;">
            </div>
        </div>
        <div id="main-content-row">
            <div id="map-container">
                <div id="map" style="height: 100%;"></div>
            </div>
            <div id="details-panel">
                <p class="details-placeholder">Haz clic en un marcador en el mapa para ver los detalles aquí.</p>
            </div>
        </div>
    </div>

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

    <!-- Leaflet.markercluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        (function () {
            const endpointUrl = 'https://query.wikidata.org/sparql';
            let map;
            let currentMarkers = [];
            let markerClusterGroup;
            let movementDataCache = {};
            let detailsPanel;
            let currentWikiRequest = null;

            const artisticMovements = [
                { name: "Pop Art", uri: "http://www.wikidata.org/entity/Q134147", startYear: "1950s", endYear: "1970s" },
                { name: "Expresionismo Abstracto", uri: "http://www.wikidata.org/entity/Q177725", startYear: "1940s", endYear: "1960s" },
                { name: "Surrealismo", uri: "http://www.wikidata.org/entity/Q39427", startYear: "1920s", endYear: "1950s" },
                { name: "Cubismo", uri: "http://www.wikidata.org/entity/Q42934", startYear: "1900s", endYear: "1920s" }, // (aprox. 1907-1914/1920s)
                { name: "Expresionismo", uri: "http://www.wikidata.org/entity/Q80113", startYear: "1900s", endYear: "1930s" }, // (aprox. 1905-1925/1930s)
                { name: "Art Nouveau", uri: "http://www.wikidata.org/entity/Q34636", startYear: "1890s", endYear: "1910s" }, // (Usando Q34636 como indicaste)
                { name: "Postimpresionismo", uri: "http://www.wikidata.org/entity/Q166713", startYear: "1880s", endYear: "1900s" }, // (aprox. 1886-1905)
                { name: "Simbolismo", uri: "http://www.wikidata.org/entity/Q164800", startYear: "1880s", endYear: "1910s" },
                { name: "Yōga", uri: "http://www.wikidata.org/entity/Q1633309", startYear: "1870s", endYear: "1940s" }, // (Pintura estilo occidental en Japón, Meiji en adelante)
                { name: "Nihonga", uri: "http://www.wikidata.org/entity/Q1989975", startYear: "1870s", endYear: "1940s" }, // (Pintura japonesa tradicional modernizada, Meiji en adelante)
                { name: "Impresionismo", uri: "http://www.wikidata.org/entity/Q40415", startYear: "1860s", endYear: "1890s" }, // (aprox. 1860s/70s-1880s/90s)
                { name: "Realismo", uri: "http://www.wikidata.org/entity/Q10857409", startYear: "1840s", endYear: "1870s" },
                { name: "Romanticismo", uri: "http://www.wikidata.org/entity/Q37068", startYear: "1790s", endYear: "1850s" },
                { name: "Neoclasicismo", uri: "http://www.wikidata.org/entity/Q14378", startYear: "1760s", endYear: "1830s" },
                { name: "Rococó", uri: "http://www.wikidata.org/entity/Q122960", startYear: "1730s", endYear: "1770s" },
                { name: "Barroco", uri: "http://www.wikidata.org/entity/Q37853", startYear: "1600s", endYear: "1750s" },
                { name: "Manierismo", uri: "http://www.wikidata.org/entity/Q131808", startYear: "1520s", endYear: "1590s" },
                { name: "Renacimiento", uri: "http://www.wikidata.org/entity/Q4692", startYear: "1300s", endYear: "1600s" }
            ];

            function makeSPARQLQuery(endpointUrl, sparqlQuery, doneCallback) {
                var settings = {
                    headers: { Accept: 'application/sparql-results+json' },
                    data: { query: sparqlQuery }
                };
                return $.ajax(endpointUrl, settings).then(doneCallback);
            }

            function queryPaintersAndArtworks(artisticMovementURI) {
                if (!artisticMovementURI) {
                    console.warn("queryPaintersAndArtworks called without an artisticMovementURI");
                    return "";
                }
                const sparqlQuery = `SELECT ?painter ?painterLabel ?painterDescription ?placeOfBirthLabel ?lat ?lon ?dateOfBirth ?dateOfDeath (SAMPLE(?artworkLabel) AS ?sampledArtworkLabel) (SAMPLE(?artworkImage) AS ?sampledArtworkImage) (SAMPLE(?painterImage) AS ?sampledPainterImage) (SAMPLE(?article) AS ?wikipediaArticle) WHERE {
  VALUES ?movement {
    <${artisticMovementURI}>
  }
  ?painter wdt:P31 wd:Q5;
    wdt:P106 wd:Q1028181;
    wdt:P19 ?placeOfBirth;
    wdt:P135 ?movement.
  ?placeOfBirth (p:P625/psv:P625) _:b5.
  _:b5 wikibase:geoLatitude ?lat;
    wikibase:geoLongitude ?lon.
  OPTIONAL { ?painter wdt:P569 ?dateOfBirth. }
  OPTIONAL { ?painter wdt:P570 ?dateOfDeath. }
  OPTIONAL {
    ?artwork wdt:P170 ?painter;
      (wdt:P31/(wdt:P279*)) wd:Q11060274;
      wdt:P18 ?artworkImage.
    OPTIONAL {
      ?artwork rdfs:label ?artworkLabel.
      FILTER(LANG(?artworkLabel) IN("es", "en"))
    }
  }
  OPTIONAL { ?painter wdt:P18 ?painterImage. }
  OPTIONAL {
    ?article schema:about ?painter;
      schema:inLanguage "es";
      schema:isPartOf <https://es.wikipedia.org/>.
  }
  SERVICE wikibase:label { bd:serviceParam wikibase:language "es,en,mul". }
}
GROUP BY ?painter ?painterLabel ?painterDescription ?placeOfBirthLabel ?lat ?lon ?dateOfBirth ?dateOfDeath
ORDER BY (RAND())
LIMIT 650`;
                return sparqlQuery;
            }

            // DOM Manipulation and UI Functions (addOptions is not used currently)
            /* function addOptions(domElement, json) {
                var select = document.getElementsByName(domElement)[0];
                json.forEach(function(info) {
                    var itemVal = info.item.value; // Generic item value
                    var itemLabel = info.itemLabel.value; // Generic item label
                    var option = document.createElement("option");
                    option.text = itemLabel;
                    option.value = itemVal;
                    select.add(option);
                });
            } */

            // Map Related Functions
            function createMap(options) {
                map = L.map('map', options);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?{foo}', {
                    foo: 'bar',
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                markerClusterGroup = L.markerClusterGroup({
                    maxClusterRadius: 30,
                    iconCreateFunction: function (cluster) {
                        const count = cluster.getChildCount();
                        let size = 'large';
                        if (count < 10) {
                            size = 'small';
                        } else if (count < 100) {
                            size = 'medium';
                        }
                        const iconHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background-color: rgba(129, 199, 132, 0.50); color: white; border: 2px solid #FFFFFF; box-shadow: 0 0 3px rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; font-size:16px; font-weight:bold; font-family: Arial, sans-serif;">${count}</div>`;
                        return L.divIcon({
                            html: iconHtml,
                            className: 'custom-cluster-' + size, // Not strictly needed with inline styles but good practice
                            iconSize: [42, 42], // Account for border
                            iconAnchor: [21, 21]
                        });
                    }
                });
                map.addLayer(markerClusterGroup);
            }

            function addPOIs(pois) {
                markerClusterGroup.clearLayers();
                currentMarkers = [];

                // Temporarily remove the cluster group to prevent issues if addLayer is slow with many markers
                // map.removeLayer(markerClusterGroup); 
                // ^ This line can sometimes help but let's try without it first. Add back if clearing/adding is still slow.

                clearDetailsPanel();

                const newMarkersBatch = [];

                pois.forEach(function (info) {
                    const commonsPrefix = "https://upload.wikimedia.org/wikipedia/commons/";

                    const painterLabel = info.painterLabel ? info.painterLabel.value : "Artista Desconocido";
                    let displayLetter = "?";
                    if (painterLabel === "Artista Desconocido") {
                        displayLetter = "A";
                    } else {
                        const nameParts = painterLabel.split(' ');
                        let nameForLetter = painterLabel;
                        if (nameParts.length > 1) {
                            nameForLetter = nameParts[nameParts.length - 1];
                        } else if (nameParts.length === 1 && nameParts[0] !== "") {
                            nameForLetter = nameParts[0];
                        }
                        if (nameForLetter.length > 0) {
                            displayLetter = nameForLetter.charAt(0).toUpperCase();
                        }
                    }

                    const artworkImageUrlAvailable = info.sampledArtworkImage ? info.sampledArtworkImage.value : null;
                    const painterImageUrlAvailable = info.sampledPainterImage ? info.sampledPainterImage.value : null;
                    let markerBackgroundColor;
                    let letterIconHtml;
                    const wikipediaArticleExists = info.wikipediaArticle && info.wikipediaArticle.value;
                    const borderColor = wikipediaArticleExists ? '#4A90E2' : '#FFFFFF'; // Blue if Wikipedia article exists, white otherwise

                    if (artworkImageUrlAvailable || painterImageUrlAvailable) {
                        let imageUrlForMarker = artworkImageUrlAvailable || painterImageUrlAvailable;
                        let thumbnailUrlForMarker = imageUrlForMarker; // Fallback if not a commons URL or error

                        if (imageUrlForMarker.startsWith(commonsPrefix)) {
                            try {
                                const imageFileAndPath = imageUrlForMarker.substring(commonsPrefix.length);
                                const filenameComponentForThumbnail = imageFileAndPath.substring(imageFileAndPath.lastIndexOf('/') + 1);
                                // Request a small thumbnail, e.g., 40px wide
                                thumbnailUrlForMarker = `${commonsPrefix}thumb/${imageFileAndPath}/40px-${filenameComponentForThumbnail}`;
                            } catch (e) {
                                console.error("Error constructing thumbnail URL for marker: " + imageUrlForMarker, e);
                                // Fallback to trying to use the original URL if thumbnail construction fails
                            }
                        }

                        letterIconHtml =
                            `<div style="width: 38px; height: 38px; border-radius: 50%; border: 3px solid ${borderColor}; box-shadow: 0 0 3px rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; overflow: hidden; background-color: #e0e0e0;">` + // Added a light background for images that might not fill
                            `  <img src="${thumbnailUrlForMarker}" alt="${displayLetter}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML=\'${displayLetter}'; this.parentElement.style.backgroundColor='#4A90E2';">` + // Fallback to letter if image fails
                            `</div>`;
                    } else {
                        markerBackgroundColor = '#BDBDBD'; // Grey for markers without a specific image
                        letterIconHtml =
                            `<div style="width: 38px; height: 38px; border-radius: 50%; background-color: ${markerBackgroundColor}; color: white; border: 2px solid ${borderColor}; box-shadow: 0 0 3px rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; font-size:18px; font-weight:bold; font-family: Arial, sans-serif;">` +
                            `${displayLetter}` +
                            `</div>`;
                    }

                    const customMarkerIcon = L.divIcon({
                        html: letterIconHtml,
                        className: 'custom-map-letter-icon',
                        iconSize: [40, 40],
                        iconAnchor: [20, 40],
                        popupAnchor: [0, -20]
                    });

                    const painterDescription = info.painterDescription ? info.painterDescription.value : "";
                    const birthPlaceLabel = info.placeOfBirthLabel ? info.placeOfBirthLabel.value : "Lugar de nacimiento desconocido";

                    const dobValue = info.dateOfBirth ? info.dateOfBirth.value : null;
                    const dodValue = info.dateOfDeath ? info.dateOfDeath.value : null;

                    let birthDateFormatted = "";
                    if (dobValue) {
                        try {
                            birthDateFormatted = new Date(dobValue).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                        } catch (e) {
                            console.error("Error formatting birth date:", dobValue, e);
                        }
                    }

                    let deathDateFormatted = "";
                    if (dodValue) {
                        try {
                            deathDateFormatted = new Date(dodValue).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                        } catch (e) {
                            console.error("Error formatting death date:", dodValue, e);
                        }
                    }

                    let lifespan = "";
                    if (birthDateFormatted && deathDateFormatted) {
                        lifespan = `(${birthDateFormatted} - ${deathDateFormatted})`;
                    } else if (birthDateFormatted) {
                        lifespan = `(Nacido: ${birthDateFormatted})`;
                    }

                    const artworkImageUrl = info.sampledArtworkImage ? info.sampledArtworkImage.value : null;
                    const painterImageUrl = info.sampledPainterImage ? info.sampledPainterImage.value : null;
                    const placeholderImageUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/Placeholder_view_vector.svg/640px-Placeholder_view_vector.svg.png';
                    let rawFinalImageUrl = artworkImageUrl || painterImageUrl || placeholderImageUrl;
                    let finalImageUrl = rawFinalImageUrl;

                    if (rawFinalImageUrl.startsWith(commonsPrefix) && rawFinalImageUrl !== placeholderImageUrl) {
                        try {
                            const imageFileAndPath = rawFinalImageUrl.substring(commonsPrefix.length);
                            const filenameComponentForThumbnail = imageFileAndPath.substring(imageFileAndPath.lastIndexOf('/') + 1);
                            finalImageUrl = `${commonsPrefix}thumb/${imageFileAndPath}/300px-${filenameComponentForThumbnail}`;
                        } catch (e) {
                            console.error("Error constructing thumbnail URL for popup: " + rawFinalImageUrl, e);
                            finalImageUrl = rawFinalImageUrl;
                        }
                    }

                    let artworkTitle = info.sampledArtworkLabel ? info.sampledArtworkLabel.value : "";
                    if (!artworkTitle && artworkImageUrl) artworkTitle = "Obra destacada";
                    else if (!artworkTitle && painterImageUrl && !artworkImageUrl) artworkTitle = "Retrato del artista";
                    else if (!artworkTitle && !artworkImageUrl && !painterImageUrl) artworkTitle = "Información visual no disponible";

                    const textpopup = `
<div id="content" style="font-family: sans-serif; max-width:300px;">
    <h3 style="margin-top:0; margin-bottom: 5px;">${painterLabel}</h3>
    ${lifespan ? `<p style="font-size:0.8em; margin-top:0; margin-bottom: 5px;">${lifespan}</p>` : ''}
    <p style="font-size:0.9em; margin-top:0; margin-bottom: 5px;"><strong>Nacido en:</strong> ${birthPlaceLabel}</p>
    ${painterDescription ? `<p style="font-size:0.85em; margin-top:0; margin-bottom:10px; font-style:italic;">${painterDescription}</p>` : ''}
</div>`;

                    const newMarker = L.marker([info.lat.value, info.lon.value], { icon: customMarkerIcon })
                        .bindPopup(textpopup, { maxHeight: 350, maxWidth: 300 });

                    newMarker.on('mouseover', function () {
                        this.openPopup();
                    });
                    newMarker.on('mouseout', function () {
                        this.closePopup();
                    });
                    newMarker.on('click', function () {
                        updateDetailsPanel(info);
                    });

                    newMarkersBatch.push(newMarker);
                });

                markerClusterGroup.addLayers(newMarkersBatch);
                currentMarkers = newMarkersBatch;
            }

            $(function () {
                detailsPanel = $('#details-panel');
                const artisticMovementSlider = $('#artisticMovementSlider');
                const sliderLabelsContainer = $('#slider-labels');
                const sliderBottomLabelsContainer = $('<div id="slider-bottom-labels"></div>');

                // Add bottom labels container after the slider
                artisticMovementSlider.after(sliderBottomLabelsContainer);

                // Clear any existing labels
                sliderLabelsContainer.empty();
                sliderBottomLabelsContainer.empty();

                // Create a reversed copy of the movements array for display
                const reversedMovements = [...artisticMovements].reverse();

                // Calculate the width of each segment
                const segmentWidth = 100 / (reversedMovements.length - 1);

                reversedMovements.forEach((movement, indexInReversed) => {
                    const position = indexInReversed * segmentWidth;

                    const labelContainer = $('<div>').addClass('slider-label').css('left', position + '%');
                    labelContainer.attr('data-uri', movement.uri); // Store URI for easy identification

                    const nameSpan = $('<span>').text(movement.name).attr('title', movement.name);
                    labelContainer.append(nameSpan);

                    labelContainer.on('click', function () {
                        artisticMovementSlider.val(indexInReversed).trigger('input');
                    });

                    if (indexInReversed % 2 === 0) {
                        sliderLabelsContainer.append(labelContainer);
                    } else {
                        sliderBottomLabelsContainer.append(labelContainer);
                    }
                });

                artisticMovementSlider.attr('max', reversedMovements.length - 1); // Max value is based on reversed length

                const initialMapOptions = {
                    center: [45, 10],
                    minZoom: 2,
                    zoom: 4
                };
                createMap(initialMapOptions);

                function updateMapForMovement(movementURI) {
                    if (!movementURI) {
                        console.log("No movement URI provided, clearing map.");
                        markerClusterGroup.clearLayers();
                        currentMarkers = [];
                        clearDetailsPanel();
                        $('#slider-labels .slider-label, #slider-bottom-labels .slider-label').removeClass('active-label');
                        return;
                    }

                    const actualMovementData = artisticMovements.find(m => m.uri === movementURI); // Get data from original array

                    if (actualMovementData) {
                        // Clear active class from all labels
                        $('#slider-labels .slider-label, #slider-bottom-labels .slider-label').removeClass('active-label');

                        // Add active class to the current one
                        const labelToActivate = $(`.slider-label[data-uri="${movementURI}"]`);
                        if (labelToActivate.length) {
                            labelToActivate.addClass('active-label');
                        }
                    } else {
                        $('#slider-labels .slider-label, #slider-bottom-labels .slider-label').removeClass('active-label');
                    }

                    if (movementDataCache[movementURI]) {
                        console.log("Using cached painters for movement " + movementURI + ":", movementDataCache[movementURI]);
                        addPOIs(movementDataCache[movementURI]);
                    } else {
                        console.warn("Data for movement " + movementURI + " not found in cache. Fetching now.");
                        const sparqlQueryContent = queryPaintersAndArtworks(movementURI);
                        if (sparqlQueryContent) {
                            makeSPARQLQuery(endpointUrl, sparqlQueryContent, function (data) {
                                console.log("Painters for movement " + movementURI + ":", data.results.bindings);
                                movementDataCache[movementURI] = data.results.bindings;
                                addPOIs(data.results.bindings);
                            }).fail(function (jqXHR, textStatus, errorThrown) {
                                console.error("Failed to fetch data for movement " + movementURI + " on demand: " + textStatus, errorThrown);
                                markerClusterGroup.clearLayers();
                                currentMarkers = [];
                                clearDetailsPanel();
                            });
                        } else {
                            markerClusterGroup.clearLayers();
                            currentMarkers = [];
                            clearDetailsPanel();
                        }
                    }
                }

                artisticMovements.forEach(function (movement) { // Pre-fetch based on original array
                    const movementURI = movement.uri;
                    if (movementURI) {
                        const sparqlQueryContent = queryPaintersAndArtworks(movementURI);
                        if (sparqlQueryContent) {
                            makeSPARQLQuery(endpointUrl, sparqlQueryContent, function (data) {
                                console.log("Pre-fetched painters for movement " + movementURI + ":", data.results.bindings);
                                movementDataCache[movementURI] = data.results.bindings;

                                // If this pre-fetched movement is the one currently selected on the slider, update map
                                const currentSliderVal = parseInt(artisticMovementSlider.val());
                                if (reversedMovements[currentSliderVal] && movementURI === reversedMovements[currentSliderVal].uri) {
                                    updateMapForMovement(movementURI);
                                }
                            }).fail(function (jqXHR, textStatus, errorThrown) {
                                console.error("Failed to pre-fetch data for movement " + movementURI + ": " + textStatus, errorThrown);
                            });
                        }
                    }
                });

                artisticMovementSlider.on('input change', function () {
                    const selectedReversedIndex = parseInt($(this).val());
                    if (reversedMovements[selectedReversedIndex]) {
                        const selectedMovement = reversedMovements[selectedReversedIndex];
                        updateMapForMovement(selectedMovement.uri);
                    }
                });

                // Initial setup based on slider's default value (usually 0)
                const initialReversedIndex = parseInt(artisticMovementSlider.val());
                if (reversedMovements[initialReversedIndex]) {
                    updateMapForMovement(reversedMovements[initialReversedIndex].uri);
                }
            });

            function updateDetailsPanel(info) {
                if (!detailsPanel) return;

                if (currentWikiRequest) {
                    currentWikiRequest.abort();
                    currentWikiRequest = null;
                }

                const painterLabel = info.painterLabel ? info.painterLabel.value : "Artista Desconocido";
                const painterDescription = info.painterDescription ? info.painterDescription.value : "Sin descripción disponible.";
                const birthPlaceLabel = info.placeOfBirthLabel ? info.placeOfBirthLabel.value : "Lugar de nacimiento desconocido";

                const dobValue = info.dateOfBirth ? info.dateOfBirth.value : null;
                const dodValue = info.dateOfDeath ? info.dateOfDeath.value : null;

                let birthDateFormatted = "Fecha de nacimiento desconocida";
                if (dobValue) {
                    try {
                        birthDateFormatted = new Date(dobValue).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                    } catch (e) { /* console.error("Error formatting birth date for details panel:", dobValue, e); */ }
                }

                let deathDateFormatted = "Fecha de fallecimiento desconocida";
                if (dodValue) {
                    try {
                        deathDateFormatted = new Date(dodValue).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                    } catch (e) { /* console.error("Error formatting death date for details panel:", dodValue, e); */ }
                }

                let lifespanDetail = "";
                if (dobValue && dodValue) {
                    lifespanDetail = `${birthDateFormatted} - ${deathDateFormatted}`;
                } else if (dobValue) {
                    lifespanDetail = `Nacido/a: ${birthDateFormatted}`;
                } else {
                    lifespanDetail = "Periodo de vida desconocido";
                }

                const artworkImageUrl = info.sampledArtworkImage ? info.sampledArtworkImage.value : null;
                const painterImageUrl = info.sampledPainterImage ? info.sampledPainterImage.value : null;
                const placeholderImageUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/Placeholder_view_vector.svg/640px-Placeholder_view_vector.svg.png';
                let rawFinalImageUrl = artworkImageUrl || painterImageUrl || placeholderImageUrl;
                let finalImageUrl = rawFinalImageUrl;

                const commonsPrefix = "https://upload.wikimedia.org/wikipedia/commons/";
                if (rawFinalImageUrl.startsWith(commonsPrefix) && rawFinalImageUrl !== placeholderImageUrl) {
                    try {
                        const imageFileAndPath = rawFinalImageUrl.substring(commonsPrefix.length);
                        const filenameComponentForThumbnail = imageFileAndPath.substring(imageFileAndPath.lastIndexOf('/') + 1);
                        finalImageUrl = `${commonsPrefix}thumb/${imageFileAndPath}/400px-${filenameComponentForThumbnail}`;
                    } catch (e) {
                        console.error("Error constructing thumbnail URL for details panel: " + rawFinalImageUrl, e);
                        finalImageUrl = rawFinalImageUrl;
                    }
                }

                let artworkTitle = info.sampledArtworkLabel ? info.sampledArtworkLabel.value : "";
                if (!artworkTitle && artworkImageUrl) artworkTitle = "Obra destacada";
                else if (!artworkTitle && painterImageUrl && !artworkImageUrl) artworkTitle = "Retrato del artista";
                else if (!artworkTitle && !artworkImageUrl && !painterImageUrl) artworkTitle = "Información visual no disponible";

                const detailsHtml = `
            <h2 style="margin-top:0;">${painterLabel}</h2>
            <p><strong>Periodo de vida:</strong> ${lifespanDetail}</p>
            <p><strong>Lugar de Nacimiento:</strong> ${birthPlaceLabel}</p>
            <p><em>${painterDescription}</em></p>
            <div style="text-align:center; margin-top:15px;">
                <img src="${finalImageUrl}" alt="${artworkTitle}" style="max-width:100%; max-height:400px; border:1px solid #ccc; object-fit: contain;" />
                ${artworkTitle ? `<p style="font-size:0.9em; margin-top:5px;"><em>${artworkTitle}</em></p>` : ''}
            </div>
            <div id="wikipedia-summary-container" style="margin-top:15px;">
                <p><em>Cargando resumen de Wikipedia...</em></p>
            </div>
        `;
                detailsPanel.html(detailsHtml);

                const wikipediaArticleUrl = info.wikipediaArticle ? info.wikipediaArticle.value : null;
                if (wikipediaArticleUrl) {
                    fetchWikipediaSummary(wikipediaArticleUrl,
                        function (summary) {
                            if (detailsPanel.find('#wikipedia-summary-container').length > 0 &&
                                detailsPanel.find('h2').first().text() === painterLabel) {
                                const summaryContainer = detailsPanel.find('#wikipedia-summary-container');
                                summaryContainer.html(`<h4 style="margin-bottom:5px;">Resumen de Wikipedia:</h4><p style="font-size:0.9em;">${summary}</p><p><a href="${wikipediaArticleUrl}" target="_blank">Leer más en Wikipedia</a></p>`);
                            }
                        },
                        function (errorMsg) {
                            if (detailsPanel.find('#wikipedia-summary-container').length > 0 &&
                                detailsPanel.find('h2').first().text() === painterLabel) {
                                const summaryContainer = detailsPanel.find('#wikipedia-summary-container');
                                summaryContainer.html(`<p style="font-size:0.9em; color:grey;"><em>${errorMsg}</em></p>`);
                            }
                        }
                    );
                } else {
                    const summaryContainer = detailsPanel.find('#wikipedia-summary-container');
                    summaryContainer.html('<p style="font-size:0.9em; color:grey;"><em>No se encontró artículo de Wikipedia para este pintor.</em></p>');
                }
            }

            function fetchWikipediaSummary(pageUrl, callbackSuccess, callbackError) {
                if (!pageUrl) {
                    if (callbackError) callbackError("No Wikipedia URL provided.");
                    return;
                }

                let pageTitle = pageUrl.substring(pageUrl.lastIndexOf('/') + 1);

                try {
                    pageTitle = decodeURIComponent(pageTitle);
                } catch (e) {
                    console.error("Failed to decode page title:", pageTitle, e);
                    if (callbackError) callbackError("Título de Wikipedia malformado o inválido.");
                    return;
                }

                if (!pageTitle) {
                    if (callbackError) callbackError("Could not extract title from Wikipedia URL.");
                    return;
                }

                const WIKIPEDIA_API_ENDPOINT = 'https://es.wikipedia.org/w/api.php';

                const thisSpecificRequest = $.ajax({
                    url: WIKIPEDIA_API_ENDPOINT,
                    data: {
                        action: 'query',
                        format: 'json',
                        prop: 'extracts',
                        exintro: true,
                        explaintext: true,
                        redirects: 1,
                        titles: pageTitle,
                        origin: '*'
                    },
                    dataType: 'jsonp',
                    success: function (response) {
                        const wasThisTheCurrentRequest = (currentWikiRequest === thisSpecificRequest);

                        if (wasThisTheCurrentRequest) {
                            currentWikiRequest = null;
                            try {
                                const pages = response.query.pages;
                                const pageId = Object.keys(pages)[0];
                                if (pageId && pages[pageId].extract) {
                                    if (callbackSuccess) callbackSuccess(pages[pageId].extract);
                                } else if (pages[pageId] && pages[pageId].missing !== undefined) {
                                    if (callbackError) callbackError("La página de Wikipedia no fue encontrada o no tiene resumen.");
                                } else {
                                    if (callbackError) callbackError("No se pudo extraer el resumen de Wikipedia.");
                                }
                            } catch (e) {
                                console.error("Error parsing Wikipedia API response for '" + pageTitle + "':", e);
                                if (callbackError) callbackError("Error al procesar la respuesta de Wikipedia.");
                            }
                        } else {
                            console.log("Success response for a superseded Wikipedia request for '" + pageTitle + "'. UI not updated.");
                        }
                    },
                    error: function (jqXHR_this, textStatus, errorThrown) {
                        const wasThisTheCurrentRequest = (currentWikiRequest === thisSpecificRequest);

                        if (wasThisTheCurrentRequest) {
                            currentWikiRequest = null;
                        }

                        if (textStatus === 'abort') {
                            console.log("Wikipedia request for '" + pageTitle + "' was aborted.");
                        } else {
                            console.error("Wikipedia API request for '" + pageTitle + "' failed: " + textStatus, errorThrown);
                            if (wasThisTheCurrentRequest) {
                                if (callbackError) callbackError("No se pudo contactar con Wikipedia para obtener el resumen.");
                            } else {
                                console.log("Error belonged to a superseded Wikipedia request for '" + pageTitle + "'. UI not updated with this error.");
                            }
                        }
                    }
                });
                currentWikiRequest = thisSpecificRequest;
            }

            function clearDetailsPanel() {
                if (!detailsPanel) return;

                if (currentWikiRequest) {
                    currentWikiRequest.abort();
                    currentWikiRequest = null;
                }
                detailsPanel.html('<p>Haz clic en un marcador en el mapa para ver los detalles aquí.</p>');
            }

        })();

    </script>
    <footer id="page-footer">
        <p>Los marcadores azules tienen un articulo en Wikipedia</p>
        <p>Realizado por Javier Francisco Dibo Gómez</p>
    </footer>
</body>

</html>